# Story S7.1 - Accès Mode Scan

| Champ | Valeur |
|-------|--------|
| **ID** | S7.1 |
| **Epic** | E7 - Scan & Contrôle |
| **Priorité** | P0 (Critique) |
| **Complexité** | Medium |
| **Estimation** | 2-3 heures |

---

## User Story

**En tant qu'** organisateur
**Je veux** accéder au mode scan sur mon mobile
**Afin de** contrôler les entrées à mon événement

---

## Contexte Technique

### Ce qui existe déjà ✅

**Backend (100% complet):**
- `ScanController@index` - renvoie les événements de l'organisateur
- `ScanController@validate` - valide un QR code (UUID + HMAC)
- `ScanController@history` - historique des scans
- `ScanController@offlineData` - données pour mode offline
- `ScanController@syncOfflineScans` - synchronisation offline → online
- `ValidateScanRequest` - validation des requêtes
- Routes configurées: `/organizer/scan/*`

**Ce qui manque (cette story):**
- Page frontend `pages/scan/index.tsx`
- Sélecteur d'événement
- Demande permission caméra
- Interface mobile-first

---

## Critères d'Acceptation

### AC-1: Accès depuis le dashboard organisateur
- [ ] Bouton "Scanner" visible sur chaque événement dans le dashboard
- [ ] Lien dans le menu organisateur vers `/organizer/scan`
- [ ] Redirection automatique si un seul événement actif

### AC-2: Sélection de l'événement
- [ ] Liste des événements publiés de l'organisateur
- [ ] Affiche: titre, date, lieu
- [ ] Filtre automatique: événements avec `starts_at >= now() - 1 jour`
- [ ] Bouton "Démarrer le scan" par événement

### AC-3: Interface mobile-first
- [ ] Design responsive optimisé mobile (viewport < 768px)
- [ ] Boutons larges et facilement cliquables (min 44x44px)
- [ ] Texte lisible (min 16px)
- [ ] Header fixe avec nom de l'événement sélectionné

### AC-4: Demande accès caméra
- [ ] Popup navigateur pour autorisation caméra au clic "Démarrer"
- [ ] Message explicatif si permission refusée
- [ ] Instruction pour réactiver la permission

### AC-5: États de l'interface
- [ ] État vide: "Aucun événement actif à scanner"
- [ ] État chargement: skeleton loader
- [ ] État erreur permission: message + lien aide

---

## Spécifications Techniques

### Route & Controller

```
GET /organizer/scan → ScanController@index
```

**Props Inertia:**
```typescript
interface ScanIndexProps {
  events: Array<{
    id: number;
    title: string;
    slug: string;
    starts_at: string;
    location: string;
    city: string;
  }>;
  selectedEventId: number | null;
}
```

### Fichiers à créer

```
resources/js/pages/scan/index.tsx          # Page principale
resources/js/components/scan/EventSelector.tsx  # Liste événements
resources/js/components/scan/CameraPermission.tsx # Gestion permission
```

### Structure de la page

```tsx
// pages/scan/index.tsx
export default function ScanIndex({ events, selectedEventId }: ScanIndexProps) {
  const [selectedEvent, setSelectedEvent] = useState(selectedEventId);
  const [cameraPermission, setCameraPermission] = useState<'prompt' | 'granted' | 'denied'>('prompt');

  // Si événement sélectionné et permission accordée → afficher scanner (S7.2)
  // Sinon → afficher sélecteur d'événement
}
```

### Composant EventSelector

```tsx
interface EventSelectorProps {
  events: Event[];
  onSelect: (eventId: number) => void;
}

// Affiche une liste de cards cliquables
// Chaque card: titre, date formatée, lieu
// Bouton "Scanner cet événement"
```

### Gestion Permission Caméra

```typescript
async function requestCameraPermission(): Promise<PermissionState> {
  try {
    const result = await navigator.permissions.query({ name: 'camera' as PermissionName });
    return result.state;
  } catch {
    // Fallback: tenter getUserMedia directement
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ video: true });
      stream.getTracks().forEach(track => track.stop());
      return 'granted';
    } catch {
      return 'denied';
    }
  }
}
```

### Styles Mobile-First

```tsx
// Utiliser Tailwind avec breakpoints
<div className="min-h-screen bg-background">
  {/* Header fixe */}
  <header className="sticky top-0 z-10 bg-background border-b p-4">
    <h1 className="text-lg font-semibold">Scanner les billets</h1>
  </header>

  {/* Contenu scrollable */}
  <main className="p-4 space-y-4">
    {/* EventSelector ou Scanner */}
  </main>
</div>
```

---

## Tests Requis

### Tests Feature (Pest)

```php
// tests/Feature/ScanControllerTest.php

it('shows scan index for organizer', function () {
    $user = User::factory()->organizer()->create();
    $event = Event::factory()->for($user)->published()->create();

    $this->actingAs($user)
        ->get('/organizer/scan')
        ->assertOk()
        ->assertInertia(fn ($page) => $page
            ->component('scan/index')
            ->has('events', 1)
        );
});

it('filters only active events', function () {
    $user = User::factory()->organizer()->create();

    // Événement passé (il y a 2 jours)
    Event::factory()->for($user)->published()->create([
        'starts_at' => now()->subDays(2),
    ]);

    // Événement actif (demain)
    Event::factory()->for($user)->published()->create([
        'starts_at' => now()->addDay(),
    ]);

    $this->actingAs($user)
        ->get('/organizer/scan')
        ->assertInertia(fn ($page) => $page
            ->has('events', 1) // Seulement l'événement actif
        );
});

it('denies access to non-organizer', function () {
    $user = User::factory()->create(['is_organizer' => false]);

    $this->actingAs($user)
        ->get('/organizer/scan')
        ->assertForbidden();
});
```

---

## Dépendances

### Packages npm (déjà installés ou à vérifier)
- `@radix-ui/react-dialog` - pour modales (shadcn)
- Pas besoin de `html5-qrcode` pour cette story (S7.2)

### Composants shadcn/ui requis
- `Card` - pour les événements
- `Button` - actions
- `Alert` - messages permission

---

## Definition of Done

- [ ] Page `/organizer/scan` accessible et fonctionnelle
- [ ] Liste des événements affichée correctement
- [ ] Sélection d'événement fonctionne
- [ ] Permission caméra demandée au bon moment
- [ ] Interface responsive testée sur mobile (DevTools)
- [ ] Tests Pest passent (3 minimum)
- [ ] Code formaté avec Pint
- [ ] TypeScript sans erreurs

---

## Notes d'implémentation

1. **Commencer par la page de base** avec le sélecteur d'événement
2. **Tester la permission caméra** dans un useEffect au montage
3. **Préparer le state** pour S7.2 (événement sélectionné, permission OK)
4. **Ne pas implémenter le scanner QR** - c'est S7.2

### Wayfinder

Utiliser les routes générées:
```typescript
import { index as scanIndex } from '@/actions/App/Http/Controllers/ScanController';
// ou
import { index } from '@/routes/organizer.scan';
```

---

## Liens

- **PRD:** `_bmad-output/planning-artifacts/prd.md` - Section E7
- **Architecture:** `_bmad-output/planning-artifacts/architecture.md` - Section PWA
- **Backend existant:** `app/Http/Controllers/ScanController.php`
